package victor.training.spring.security.vulnerability;

import jakarta.annotation.PostConstruct;
import jakarta.persistence.Entity;
import jakarta.persistence.EntityManager;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.Id;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Lazy;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

@Slf4j
@Lazy
@RestController
@RequiredArgsConstructor
public class SQLInjection {
  private final JdbcTemplate jdbc;
  private final StudentRepo studentRepo;
  private final EntityManager entityManager;

  public enum OrderCol {NAME, CAMPUS}

  @GetMapping("api/vulnerability/sql-injection")
  public List<String> sqlInjection(
      @RequestParam String name,
      @RequestParam OrderCol order) {

    String sql = "SELECT NAME || ' of ' || CAMPUS " +
                 "FROM STUDENT " +
                 "WHERE UPPER(NAME) LIKE '%' || ? || '%' " +
                 "ORDER BY " + order;
//    String sql = STR."""
//"""
//        "SELECT NAME || ' of ' || CAMPUS ",
//        "FROM STUDENT ",
//        "WHERE UPPER(NAME) LIKE %s ",
//        "ORDER BY %s".formatted(name.toUpperCase(), order));
//

//    String sql = STR."""
//        SELECT NAME || ' of ' || CAMPUS
//        FROM STUDENT
//        WHERE UPPER(NAME) LIKE '\{name.toUpperCase()}'
//        ORDER BY \{order}""";
    log.info("Executing SQL: " + sql);
    return jdbc.queryForList(sql, String.class, name.toUpperCase());
  }

  @GetMapping("api/vulnerability/jpql-injection")
  public List<Student> jpqlInjection(@RequestParam String name) {
    String userVisibleCampus = "POLI"; // eg from JWT token
    name = " OR 1=1 ";
    String jpql =
        "SELECT s FROM Student s " +
        "WHERE s.campus='" + userVisibleCampus + "' " + // data security : visibility
        "AND UPPER(s.name) LIKE '%" + name.toUpperCase() + "%'";
//        "AND UPPER(s.name) LIKE '%' OR '%'='%'";

    return entityManager.createQuery(jpql, Student.class)
        .getResultList();
  }

  //<editor-fold desc="initial data">
  @PostConstruct
  public void initInitialData() {
    studentRepo.save(new Student("Ana Pintilie", "POLI"));
    studentRepo.save(new Student("Costel Moraru", "POLI"));
    studentRepo.save(new Student("Marcel Tudor", "UNIBUC"));
    studentRepo.save(new Student("Crina Carteplina", "ASE"));
    log.info("Initial data inserted");
  }
  //</editor-fold>
}

interface StudentRepo extends JpaRepository<Student, Long> {

}

@Data
@Entity
class Student {
  @Id
  @GeneratedValue
  private Long id;
  private String name;
  private String campus;

  protected Student() {
  } // for Hibernate only

  public Student(String name, String campus) {
    this.name = name;
    this.campus = campus;
  }

}
